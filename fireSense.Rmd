---
title: "fireSense"
author: "Jean Marchal"
date: "August 2016"
output:
  html_document: default
  pdf_document: default
---

# Overview
A landscape fire model sensitive to environmental changes (e.g. weather and land-cover).

# Download the module
```{r download module, eval = FALSE, echo = TRUE}
library(SpaDES)

moduleName <- "fireSense"

workingDirectory <- tempdir() # Change this to a place you would like to put the module, if desired.

downloadModule(moduleName, path = workingDirectory)
```

# Usage
## Module parameters
Name|Default|Description
----|:-------:|---------------------------------------------------------------------
`mapping`|`NULL`|optional. Named `character vector` or `list` mapping the names of data objects required by the module to those in the `simList` environment.
`initialRunTime`|`start(sim)`|optional. Simulation time at which to start this module. Defaults to simulation start time.
`intervalRunModule`|`NA`|optional. Interval in simulation time units between two runs of this module.
|||

## Usage example
```{r module usage example, eval = FALSE}
library(SpaDES)
library(magrittr)

# Packages required by the module
library(data.table)
library(raster)

set.seed(1)

nx <- ny <- 100L
n <- nx * ny
r <- raster(nrows = ny, ncols = nx, xmn = -nx/2, xmx = nx/2, ymn = -ny/2, ymx = ny/2)

# Create a map ignition probabilities
ignitProb <- gaussMap(r, scale = 10, var = .0001, speedup = nx/5e2, inMemory = TRUE)

# Create a map of escape probabilities
escapeProb <- gaussMap(r, scale = 50, var = .01, speedup = nx/5e2, inMemory = TRUE)

# Create a map of spread probabilities
spreadProb <- gaussMap(r, scale = 300, var = .05, speedup = nx/5e2, inMemory = TRUE)

# Create a map of stand age
random_ageMap <- gaussMap(r, scale = 300, var = 1e4, speedup = nx/5e2, inMemory = TRUE) %>% calc(function(x)round(x+1,0))

#outputDir <- file.path(tempdir(), "outputs")
times <- list(start = 1, end = 100, timeunit = "year")
parameters <- list(
  fireSense = list(mapping = list(ageMap = "random_ageMap") # One can use mapping to map data objects in the
                                                            # simList environment to data required by the module.
                                                            # Here random_ageMap is mapped to ageMap.  
  )
)

modules <- list("fireSense")
objects <- c("ignitProb",
             "escapeProb",
             "spreadProb",
             "random_ageMap") # Pass objects found in the global environment to the simList environment
paths <- list(
  # cachePath = file.path(outputDir, "cache"),
  modulePath = file.path("~/Documents/GitHub/McIntire-lab/modulesPrivate/") ## TODO: change this to tempdir()
  # inputPath = inputDir,
  # outputPath = outputDir
)

mySim <- simInit(times = times, params = parameters, modules = modules, objects = objects, paths = paths)

spades(mySim)
```

# Events
- ignite fires
- determine which fires escape
- spread escaped fires
- update age map

## Plotting
TODO: Write what is plotted. (there is currently nothing saved, but this may change in the future)

## Saving
TODO: Write what is saved. (there is currently nothing saved, but this may change in the future)

# Data dependencies
## Input data
- A `RasterLayer` called **ignitProb** describing ignition probabilities
- A `RasterLayer` called **escapeProb** describing escape probabilities
- A `RasterLayer` called **spreadProb** describing spread probabilities
- A `RasterLayer` or a `data.table` (with a column named **age**) called **ageMap** describing the age of forest stands
- A `RasterStack` called **vegMap** describing the distribution of vegetation types as porportions of pixel area

## Output data
<!-- TODO - number of ignitions
- number of fires that escaped
- fire sizes-->
- A `data.table` called **trajAgeMap** with fourth columns:
    - **px_id**, the pixel ID (cell number)
    - **traj**, the succession trajectory (number)
    - **age**, the age of the forest stand
    - **area**, the area covered by the forest stand

# Links to other modules
This module should be coupled with a dynamic vegetation model.

